<!doctype html>
<html lang=en id=faq>

<title>Following -current and using snapshots</title>
<meta charset=utf-8>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" type="text/css" href="../openbsd.css">
<link rel="canonical" href="https://www.openbsd.org/faq/current.html">

<h2 id=OpenBSD>
<a href="../index.html">
<i>Open</i><b>BSD</b></a>
Following -current and using snapshots
<small>
<a href="index.html">[FAQ Index]</a>
</small>
</h2>
<hr>

<p>
Active OpenBSD development is known as the
<a href="faq5.html#Flavors">-current</a> branch.
These sources are frequently compiled into releases known as <i>snapshots</i>.

<p>
Aggressive changes are sometimes pushed in this branch, and complications can
arise when building the latest code or upgrading from a previous point in time.
Some of the steps for getting over these hurdles are explained on this page.
Make sure you've read and understand how to
<a href="faq5.html">build the system from source</a> before using -current
and the instructions below.

<p>
In general, it's far easier to use snapshots, as developers will have gone
through much of the trouble for you already.

<p>
You should <b>always</b> use a snapshot as the starting point for running
-current.
This process typically consists of running
<a href="https://man.openbsd.org/sysupgrade">sysupgrade(8)</a> with the
<code>-s</code> flag.
Alternatively, download (and verify) the appropriate
<a href="faq4.html#bsd.rd">bsd.rd</a> file from the <code>/snapshots/</code>
directory of your preferred <a href="../ftp.html">mirror</a>, boot from it,
and choose <code>(U)pgrade</code> at the prompt.
Any installed packages should then be
<a href="faq15.html#PkgUpdate">upgraded</a> after booting into the new system.

<p>
Upgrading to -current by compiling your own source code is discouraged
for everyone except for experts, as difficult build-time crossing-points
can occur often, and no assistance will be provided.  In case of failure,
use a snapshot to recover.

<p>
Most of these changes will have to be performed as root.


<h3 id="r20230711">2023/07/11 - [packages] databases/influxdb upgrade to v2.7</h3>


<p>
The <tt>databases/influxdb</tt> port was upgraded to a new major version,
which has several impacts:
<ul>
<li>the <tt>influx</tt> CLI command is now in a separate <tt>influx-cli</tt>
package, and has a completely different syntax</li>

<li>authentication is now mandatory via token, and the db is multi-tenant so an
organization is also mandatory</li>

<li>the web interface is now built-in and accessible on port 8086 by
default</li>

<li>the database format needs to be upgraded (cf <a
href="https://docs.influxdata.com/influxdb/v2.7/upgrade/v1-to-v2/automatic-upgrade/">the
upstream documentation</a>):

<blockquote><pre>
# doas -u _influx influxd upgrade
</pre></blockquote>
</li>

<li>this will:
<ul>
    <li>convert the existing <tt>/etc/influxdb/influxdb.conf</tt> into
                <tt>/var/influxdb/.influxdbv2/config.toml</tt></li>
    <li>convert the data from <tt>/var/influxdb/{data,wal,meta}</tt> into
    <tt>/var/influxdb/.influxdbv2/{engine,influxd.bolt,influxd.sqlite}</tt></li>
    <li>once properly upgraded, the v1 config/files can be safely removed</li>
</ul>
</li>

<li>during upgrade it asks for l/p/org/default bucket/retention policy, that'll
also generate a client config in <tt>/var/influxdb/.influxdbv2/configs</tt>
that's used by <tt>doas -u _influx influx</tt> command afterwards for setup.
The latter also contains a token for the admin</li>

<li>for new installs, running the following will asks the same questions:
<blockquote><pre>
# doas -u _influx influx setup
</pre></blockquote></li>

<li>telegraf clients need to be updated to use <tt>outputs.influxdb_v2</tt>
plugin (with org, token and bucket) per <a
href="https://github.com/influxdata/telegraf/blob/release-1.27/plugins/outputs/influxdb_v2/README.md#configuration">the
documentation</a></li>

<li>no more collectd direct sink in influxdb, collectd now needs to talk to a
telegraf with a <a
href="https://docs.influxdata.com/telegraf/v1.9/data_formats/input/collectd/">collectd-enabled</a>
sink. An example configuration for <tt>telegraf.conf</tt> is provided below:

<blockquote><pre>
[[inputs.socket_listener]]
  service_address = "udp://:25826"
  data_format = "collectd"
  collectd_auth_file = "/etc/collectd/collectd.auth"
  collectd_security_level = "encrypt"
  collectd_typesdb = ["/usr/local/share/collectd_types.db"]
  collectd_parse_multivalue = "split"
[[outputs.influxdb_v2]]
 urls = ["http://influxdb:8086"]
 token = "$DOCKER_INFLUXDB_INIT_ADMIN_TOKEN"
 organization = "$DOCKER_INFLUXDB_INIT_ORG"
 bucket = "$DOCKER_INFLUXDB_INIT_BUCKET"
</pre></blockquote>
</li>
</ul>
</p>

<!--
     Two blank lines before new sections.
     New sentences start on new lines.
     Try to make lines shorter than 80 characters.
-->

<hr id="end">
<small>$OpenBSD: current.html,v 1.1105 2023/07/11 12:10:41 landry Exp $</small>
